<!DOCTYPE html>
<html lang="en">
    <head>
        <base target="_top">
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

        <title> VRRA - Your best reservation system </title>

        <?var url = getScriptUrl();?>
    </head>
    <body>
        <header class="navbar navbar-expand navbar-light bg-light">
            <a href="<?=url?>?page=index" class="navbar-brand">
                <img src="https://drive.google.com/uc?export=view&id=1TLkbGcFes2sW5LRnwI7r-bJc56SArNmh" alt="VRRA logo" class="img-fluid">
            </a>
            <div class="navbar-nav-scroll">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a href="<?=url?>?page=inquire" class="nav-link">
                            <div>Inquire Reservation</div>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a href="<?=url?>?page=create_reserv" class="nav-link">
                            <div>Create Reservation</div>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="<?=url?>?page=modify_reserv" class="nav-link">
                            <div>Reservation Management</div>
                        </a>
                    </li>
                </ul>
            </div>
            <ul class="navbar-nav ml-md-auto">
                <!--<li class="nav-item">
                    <button type="button" class="btn btn-primary">Sign in</button>
                </li>-->
                <!--<li class="nav-item">
                    <button type="button" class="btn btn-light">Sign up</button>
                </li>-->

                <!-- hide element: class with d-none -->
                <li class="nav-item"> 
                    <a class="nav-item nav-link px-2 py-2" href="#" data-toggle="dropdown" aria-expanded="false">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
                            <path d="M13.468 12.37C12.758 11.226 11.195 10 8 10s-4.757 1.225-5.468 2.37A6.987 6.987 0 0 0 8 15a6.987 6.987 0 0 0 5.468-2.63z"/>
                            <path fill-rule="evenodd" d="M8 9a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                            <path fill-rule="evenodd" d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"/>
                        </svg>
                        <p class="d-inline" id="userName">Identifying...</p>
                    </a>
                    <!--<div class="dropdown-menu dropdown-menu-md-right">
                        <a href="" class="dropdown-item">
                            <div>Reset password</div>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="" class="dropdown-item">
                            <div>Sign out</div>
                        </a>
                    </div>-->
                </li>
            </ul>

            <!-- display element: class without d-none -->
            <div class="alert alert-success d-none" role="alert" style="width: 30%; position: absolute; right: 1%; top: 25%;">
                <div style="display: inline;">message box</div>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </header>
        <main>
            <!-- TODO-->
            <script language="javascript">

                function addParticipant(){
                var len = optionlist.rows.length; 
                var obj = optionlist.insertRow(len);
                obj.insertCell(0);
                obj.cells[0].innerHTML="Participant" + (len+1) + ":<input type=text name=option size=28>";
                }
                function deleteParticipant(){
                    var len = optionlist.rows.length;
                    if(len > 0) {
                    optionlist.deleteRow(len-1);
                    }
                }
                </script>
            <div>
                <label for="roomNumber"></label>
                <input type="text" id="roomNumber" name="roomNumber" placeholder="Room number">
                <label for="hostName"></label>
                <input type="text" id="hostName" name="hostName" placeholder="Host name"><br>
                <labe for="meetingDate"></labe>
                <input type="date" id="meetingDate" value="">
                <label for="fromTime">Start</label>
                <input type="time" id="fromTime" name="fromTime" placeholder="From time">
                <label for="toTime">End</label>
                <input type="time" id="toTime" name="toTime" placeholder="To time">
                <button type="submit" class="btn btn-primary" style="display: inline;" id="create">Create</button>
                
                <table id="optionlist">
                    <!--<td>Participant1:<input type="text" name="option" size="28"></td>-->
                </table>
                <input type="button" id="bt1" value="add Participant" onClick="addParticipant();">
                <input type="button" id="bt2" value="delete Participant" onClick="deleteParticipant();">
            </div>
            
            <!-- TODO-->
            <!--<div style="height: 35px;"> </div>-->
        </main>
        <footer class="container-fluid bg-dark text-light py-3" style ="/*position: fixed; bottom: 0;*/">
            <address class="pt-4">
                <p class="d-inline">Contact: </p>
                <a href="mailto:109SE.group26@gmail.com">109SE.group26@gmail.com</a>
            </address>
            <p> &copy; Copyright 109SE.Group26, 2021 </p>
        </footer>

        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    </body>
    <script>
      var account = "example@aaa.com";

          $(document).ready(function() {
            google.script.run.withSuccessHandler(changeUserName).getUserAccount();
          });
          
          function changeUserName(str) {
            $("#userName").empty();
            $("#userName").append(str);
            account = str;
          }
          
      $("#create").click(function(){
        var testingData=[];
        isRN = $("#roomNumber").val() != '';
        isHN = $("#hostName").val() != '';
        isFT = $("#fromTime").val() != '';
        isTT = $("#toTime").val() != '';
        isMD = $("#meetingDate").val() != '';
        var roomNum = $("#roomNumber").val();
        var hostName = $("#hostName").val();
        var fromTime = $("#fromTime").val();
        var toTime = $("#toTime").val();
        var date = $("#meetingDate").val();
        
        testingData[0] = $("#roomNumber").val().toLowerCase();
        testingData[1] = parseInt($("#fromTime").val().replace(':',''));
        testingData[2] = parseInt($("#toTime").val().replace(':',''));
        testingData[3] = $("#meetingDate").val();
        // google.script.run.withSuccessHandler()
        
        console.log(roomNum);
        console.log(hostName);
        console.log(fromTime);
        console.log(toTime);
        console.log(date);
        if(isRN && isHN && isFT && isTT && isMD){
          var title = "You have a reservation on " + roomNum;
          google.script.run.withSuccessHandler(dataCanAccess).checkCreate(testingData);
          function dataCanAccess(dataOk){
            if(dataOk){
              google.script.run.withSuccessHandler(getCalID).createEvents(title, date, fromTime, toTime); //dangerRRR
            }
            else{
               alert("Warning! room that time is not available. Please check and try again!");
            }
          }
        }else{
          alert("Warning! You did not fill all the required information. Please check the field and try again!")
        }
      });
    
    function getCalID(id){
      console.log("Google Calendar ID:" + id);
      var roomNum = $("#roomNumber").val();
      var hostName = $("#hostName").val();
      var fromTime = $("#fromTime").val();
      var toTime = $("#toTime").val();
      var date = $("#meetingDate").val();
      var len = optionlist.rows.length; 
      var email = account; //Modify 188
      var dataAll =[];
      console.log("email::");//
      console.log(email);//
      if(len != 0){
        for(var i=0;i<len;i++){
            var data= optionlist.rows[i].cells[0].childNodes[1].value;
            dataAll.push(data);
        }
        for(var i = 0; i < len; i++){
          console.log(dataAll[i]);
          google.script.run.withSuccessHandler().addGuests(id, dataAll[i]);
        }
      }
      google.script.run.withSuccessHandler().sendCreateConfirmationMail(email, roomNum);
      google.script.run.withSuccessHandler().writeHostRRA(roomNum, hostName, fromTime, toTime, date, id, email);
      alert("Create Successfully.");
      return id;
      
    }

    </script>
</html>